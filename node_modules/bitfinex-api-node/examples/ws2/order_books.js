'use strict'

process.env.DEBUG = 'bfx:examples:*'

const debug = require('debug')('bfx:examples:ws2_order_books')
const bfx = require('../bfx')

const ws = bfx.ws(2, {
  manageOrderBooks: true, // tell the ws client to maintain full sorted OBs
  transform: true // auto-transform array OBs to OrderBook objects
})

ws.on('error', (err) => {
  debug('error: %j', err)
})

ws.on('open', () => {
  debug('open')
  ws.subscribeOrderBook('tBTCUSD')
})

ws.onMessage('', (msg) => {
  //debug(JSON.stringify(msg))
})

let lastMidPrice = -1
let midPrice
let old_bid = -1;

// 'ob' is a full OrderBook instance, with sorted arrays 'bids' & 'asks'
ws.onOrderBook({ symbol: 'tBTCUSD'}, (ob,cbGID) => {
  midPrice = ob.midPrice()
  
  if (midPrice !== lastMidPrice) {
    //console.log('BTCUSD mid price: %d',midPrice, ob.bids, ob.asks)
    console.log("Midprice:",lastMidPrice, midPrice)
    lastMidPrice = midPrice;
    
    if (midPrice !== lastMidPrice) {
      console.log("Bids:",ob.bids)
      old_bid = ob.bids[0]
    }
    
    //debug(cbGID)
  }
})

ws.open()
